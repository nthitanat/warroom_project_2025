# ============================================
# WarRoom Project - Production Configuration  
# ============================================
# Uses network_mode: host to allow direct MySQL access at 127.0.0.1
version: '3.8'

services:
  war-server:
    container_name: warroom-server
    build:
      context: ./war-server
      dockerfile: Dockerfile
    network_mode: host
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - DEPLOYMENT_MODE=production
      - PORT=${PORT:-4000}
      - API_PREFIX=${API_PREFIX:-/api}
      - API_VERSION=${API_VERSION:-v1}
      - DEV_DB_HOST=${DEV_DB_HOST}
      - DEV_DB_PORT=${DEV_DB_PORT}
      - DEV_DB_USER=${DEV_DB_USER}
      - DEV_DB_PASSWORD=${DEV_DB_PASSWORD}
      - DEV_DB_NAME=${DEV_DB_NAME}
      - PROD_DB_HOST=${PROD_DB_HOST}
      - PROD_DB_PORT=${PROD_DB_PORT}
      - PROD_DB_USER=${PROD_DB_USER}
      - PROD_DB_PASSWORD=${PROD_DB_PASSWORD}
      - PROD_DB_NAME=${PROD_DB_NAME}
      - DEV_JWT_SECRET=${DEV_JWT_SECRET}
      - DEV_JWT_EXPIRES_IN=${DEV_JWT_EXPIRES_IN}
      - PROD_JWT_SECRET=${PROD_JWT_SECRET}
      - PROD_JWT_EXPIRES_IN=${PROD_JWT_EXPIRES_IN}
      - DEV_CORS_ORIGIN=${DEV_CORS_ORIGIN}
      - PROD_CORS_ORIGIN=${PROD_CORS_ORIGIN}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-900000}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-100}
      - UPLOAD_DIR=${UPLOAD_DIR:-./public}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-10485760}
    volumes:
      - ./war-server/public:/app/public
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:${PORT:-4000}/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  war-front:
    container_name: warroom-frontend
    build:
      context: ./war-front
      dockerfile: Dockerfile
      args:
        NODE_ENV: production
        REACT_APP_API_BASE_URL: ${PROD_REACT_APP_API_BASE_URL}
        REACT_APP_ENABLE_API_LOGGING: ${PROD_REACT_APP_ENABLE_API_LOGGING}
    network_mode: host
    env_file:
      - .env
    depends_on:
      - war-server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
